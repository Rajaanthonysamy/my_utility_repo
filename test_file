from rdflib import Graph, RDF, RDFS, OWL, Namespace
from rdflib.namespace import SH, XSD

def parse_ontology(ttl_path):
    g = Graph()
    g.parse(ttl_path, format="turtle")

    # capture prefixes
    prefix_map = {pfx: str(uri) for pfx, uri in g.namespaces()}

    classes = []
    data_properties = []
    object_properties = []
    shapes = []

    for s in g.subjects(RDF.type, OWL.Class):
        classes.append(extract_class(g, s, prefix_map))

    for s in g.subjects(RDF.type, OWL.DatatypeProperty):
        data_properties.append(extract_dataprop(g, s, prefix_map))

    for s in g.subjects(RDF.type, OWL.ObjectProperty):
        object_properties.append(extract_objprop(g, s, prefix_map))

    for s in g.subjects(RDF.type, SH.NodeShape):
        shapes.append(extract_shape(g, s, prefix_map))
    
    return classes, data_properties, object_properties, shapes


def get_prefixed(uri, prefix_map):
    """Convert full URI to prefixed form"""
    for pfx, ns in prefix_map.items():
        if uri.startswith(ns):
            return f"{pfx}:{uri[len(ns):]}"
    return uri  # fallback full URI


def extract_class(g, class_uri, prefix_map):
    label = g.value(class_uri, RDFS.label)
    definition = g.value(class_uri, Namespace("http://www.w3.org/2004/02/skos/core#").definition)
    subclass = g.value(class_uri, RDFS.subClassOf)

    return {
        "class": get_prefixed(str(class_uri), prefix_map),
        "label": str(label) if label else None,
        "definition": str(definition) if definition else None,
        "subclass_of": get_prefixed(str(subclass), prefix_map) if subclass else None,
    }


def extract_dataprop(g, prop_uri, prefix_map):
    label = g.value(prop_uri, RDFS.label)
    definition = g.value(prop_uri, Namespace("http://www.w3.org/2004/02/skos/core#").definition)
    datatype = g.value(prop_uri, RDFS.range)

    return {
        "datatype_property": get_prefixed(str(prop_uri), prefix_map),
        "label": str(label) if label else None,
        "definition": str(definition) if definition else None,
        "datatype": get_prefixed(str(datatype), prefix_map) if datatype else None,
    }


def extract_objprop(g, prop_uri, prefix_map):
    domain = g.value(prop_uri, RDFS.domain)
    range_ = g.value(prop_uri, RDFS.range)

    return {
        "object_property": get_prefixed(str(prop_uri), prefix_map),
        "domain": get_prefixed(str(domain), prefix_map) if domain else None,
        "range": get_prefixed(str(range_), prefix_map) if range_ else None,
    }


def extract_shape(g, shape_uri, prefix_map):
    props = []

    for prop in g.objects(shape_uri, SH.property):
        path = g.value(prop, SH.path)
        datatype = g.value(prop, SH.datatype)
        class_ = g.value(prop, SH["class"])

        props.append({
            "path": get_prefixed(str(path), prefix_map) if path else None,
            "datatype": get_prefixed(str(datatype), prefix_map) if datatype else None,
            "class": get_prefixed(str(class_), prefix_map) if class_ else None
        })

    return {
        "shape": get_prefixed(str(shape_uri), prefix_map),
        "properties": props,
    }
