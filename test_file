from rdflib import (
    Graph, Namespace, RDF, RDFS, OWL,
    URIRef
)
from rdflib.namespace import SKOS, DCTERMS, XSD, SH
from rdflib.collection import Collection

# FIX for sh:or
SH_OR = URIRef("http://www.w3.org/ns/shacl#or")


# ============================================================
# LOAD GRAPH
# ============================================================
def load_graph(file_path):
    g = Graph()
    g.parse(file_path, format="turtle")
    return g


# ============================================================
# SHACL PROPERTIES EXTRACTOR
# ============================================================
def extract_shacl_properties(g, node):
    props = []

    for shprop in g.objects(node, SH.property):
        prop_info = {}

        for pred, obj in g.predicate_objects(shprop):

            pred_name = pred.split("#")[-1] if "#" in pred else pred.split("/")[-1]

            # SHACL or
            if pred == SH_OR:
                or_list = []
                collection = Collection(g, obj)

                for item in collection:
                    nested = {}
                    for p2, o2 in g.predicate_objects(item):
                        nested_pred = p2.split("#")[-1]
                        nested[nested_pred] = str(o2)
                    or_list.append(nested)
                prop_info["or"] = or_list
                continue

            prop_info[pred_name] = str(obj)

        props.append(prop_info)

    return props


# ============================================================
# CLASS EXTRACTOR
# ============================================================
def extract_class_info(g, cls):
    info = {
        "type": "owl:Class",
        "uri": str(cls),
    }

    label = g.value(cls, RDFS.label)
    if label:
        info["label"] = str(label)

    definition = g.value(cls, SKOS.definition)
    if definition:
        info["definition"] = str(definition)

    # alt labels
    alt_labels = [str(a) for a in g.objects(cls, SKOS.altLabel)]
    if alt_labels:
        info["alt_labels"] = alt_labels

    # SHACL
    sh_props = extract_shacl_properties(g, cls)
    if sh_props:
        info["shacl_properties"] = sh_props

    return info


# ============================================================
# DATATYPE PROPERTY EXTRACTOR
# ============================================================
def extract_datatype_property(g, prop):
    info = {
        "type": "owl:DatatypeProperty",
        "uri": str(prop),
    }

    label = g.value(prop, RDFS.label)
    if label:
        info["label"] = str(label)

    definition = g.value(prop, SKOS.definition)
    if definition:
        info["definition"] = str(definition)

    created = g.value(prop, DCTERMS.created)
    if created:
        info["created"] = str(created)

    creator = g.value(prop, DCTERMS.creator)
    if creator:
        info["creator"] = str(creator)

    return info


# ============================================================
# OBJECT PROPERTY EXTRACTOR
# ============================================================
def extract_object_property(g, prop):
    info = {
        "type": "owl:ObjectProperty",
        "uri": str(prop),
    }

    label = g.value(prop, RDFS.label)
    if label:
        info["label"] = str(label)

    definition = g.value(prop, SKOS.definition)
    if definition:
        info["definition"] = str(definition)

    # Domain
    domain = g.value(prop, RDFS.domain)
    if domain:
        info["domain"] = str(domain)

    # Range
    range_ = g.value(prop, RDFS.range)
    if range_:
        info["range"] = str(range_)

    return info


# ============================================================
# MAIN EXTRACTION
# ============================================================
def extract_full_ontology(file_path):
    g = load_graph(file_path)

    ontology = []

    # ---- CLASSES ----
    for cls in g.subjects(RDF.type, OWL.Class):
        ontology.append(extract_class_info(g, cls))

    # ---- DATATYPE PROPERTIES ----
    for prop in g.subjects(RDF.type, OWL.DatatypeProperty):
        ontology.append(extract_datatype_property(g, prop))

    # ---- OBJECT PROPERTIES ----
    for prop in g.subjects(RDF.type, OWL.ObjectProperty):
        ontology.append(extract_object_property(g, prop))

    return ontology


# ============================================================
# RUN
# ============================================================
if __name__ == "__main__":
    file_path = "medusa.ttl"

    ontology_data = extract_full_ontology(file_path)

    for item in ontology_data:
        print("\n==============================")
        print(item)
