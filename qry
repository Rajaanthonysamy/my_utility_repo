from pystardog import Connection

class RAGOptimizedExtractor:
    def __init__(self, endpoint, database, username, password):
        self.conn = Connection(
            database=database,
            endpoint=endpoint,
            username=username,
            password=password
        )
    
    def get_class_centric_documents(self):
        """Create rich, class-centric documents for RAG"""
        
        # Query to get classes with all related info
        query = """
        PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
        PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
        PREFIX owl: <http://www.w3.org/2002/07/owl#>
        
        SELECT DISTINCT 
          ?class 
          ?classLabel 
          ?classComment
          ?subClassOf
          ?subClassLabel
          (GROUP_CONCAT(DISTINCT ?property; separator="|") AS ?properties)
          (GROUP_CONCAT(DISTINCT ?propertyLabel; separator="|") AS ?propertyLabels)
          (GROUP_CONCAT(DISTINCT ?range; separator="|") AS ?ranges)
          (GROUP_CONCAT(DISTINCT ?rangeLabel; separator="|") AS ?rangeLabels)
        WHERE {
          ?class a owl:Class .
          OPTIONAL { ?class rdfs:label ?classLabel }
          OPTIONAL { ?class rdfs:comment ?classComment }
          OPTIONAL { 
            ?class rdfs:subClassOf ?subClassOf .
            OPTIONAL { ?subClassOf rdfs:label ?subClassLabel }
          }
          
          # Get properties that have this class as domain
          OPTIONAL {
            ?property rdfs:domain ?class .
            OPTIONAL { ?property rdfs:label ?propertyLabel }
            OPTIONAL { 
              ?property rdfs:range ?range .
              OPTIONAL { ?range rdfs:label ?rangeLabel }
            }
          }
          
          FILTER(?class != owl:Thing && ?class != owl:Nothing)
        }
        GROUP BY ?class ?classLabel ?classComment ?subClassOf ?subClassLabel
        ORDER BY ?class
        """
        
        results = self.conn.select(query)
        documents = []
        
        for binding in results['results']['bindings']:
            class_uri = binding['class']['value']
            class_label = binding.get('classLabel', {}).get('value', 
                         class_uri.split('#')[-1].split('/')[-1])
            class_comment = binding.get('classComment', {}).get('value', '')
            
            # Parse properties
            properties_str = binding.get('properties', {}).get('value', '')
            property_labels_str = binding.get('propertyLabels', {}).get('value', '')
            ranges_str = binding.get('ranges', {}).get('value', '')
            range_labels_str = binding.get('rangeLabels', {}).get('value', '')
            
            properties = properties_str.split('|') if properties_str else []
            property_labels = property_labels_str.split('|') if property_labels_str else []
            ranges = ranges_str.split('|') if ranges_str else []
            range_labels = range_labels_str.split('|') if range_labels_str else []
            
            # Build rich text description
            text = self._build_class_document(
                class_label, 
                class_comment, 
                binding.get('subClassLabel', {}).get('value', ''),
                properties,
                property_labels,
                ranges,
                range_labels
            )
            
            documents.append({
                'type': 'class',
                'uri': class_uri,
                'label': class_label,
                'text': text,
                'metadata': {
                    'class_uri': class_uri,
                    'properties': properties,
                    'property_labels': property_labels
                }
            })
        
        return documents
    
    def _build_class_document(self, class_label, class_comment, parent_class, 
                              properties, property_labels, ranges, range_labels):
        """Build semantically rich text for embedding"""
        
        text = f"Class: {class_label}"
        
        if class_comment:
            text += f". Description: {class_comment}"
        
        if parent_class:
            text += f". This is a type of {parent_class}"
        
        # Add properties in natural language
        if property_labels:
            text += f". Properties of {class_label} include: "
            prop_descriptions = []
            
            for i, prop_label in enumerate(property_labels):
                if prop_label:  # Skip empty labels
                    range_label = range_labels[i] if i < len(range_labels) else 'unknown'
                    if range_label:
                        prop_descriptions.append(f"{prop_label} (which relates to {range_label})")
                    else:
                        prop_descriptions.append(prop_label)
            
            text += ", ".join(prop_descriptions)
        
        text += "."
        
        return text

# Usage
extractor = RAGOptimizedExtractor(
    endpoint="http://localhost:5820",
    database="my_database",
    username="admin",
    password="admin"
)

class_documents = extractor.get_class_centric_documents()

# Example output:
# "Class: Person. Description: An individual human being. Properties of Person include: 
#  hasName (which relates to String), worksFor (which relates to Organization), 
#  hasAge (which relates to Integer), livesIn (which relates to Location)."
